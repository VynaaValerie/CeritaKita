<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CeritaKita - Berbagi Cerita Harian</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        .create-post {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        .post-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        .post-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            margin-right: 15px;
        }
        .post-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .post-button:hover {
            transform: translateY(-2px);
        }
        .post-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .posts-container {
            padding: 20px;
        }
        .post {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s;
        }
        .post:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .post-user {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }
        .post-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        .post-content {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.05em;
        }
        .post-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.2s;
        }
        .stat:hover {
            color: #667eea;
        }
        .comment-section {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
            margin-top: 15px;
        }
        .comment-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .comment {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }
        .comment-user {
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
        }
        .comment-text {
            color: #495057;
            margin: 5px 0;
        }
        .comment-time {
            color: #6c757d;
            font-size: 0.8em;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
        .success {
            background: #e6f7e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
        .retry-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® CeritaKita</h1>
            <p>Berbagi cerita harian dengan penuh makna</p>
        </div>
        
        <div class="create-post">
            <textarea class="post-input" placeholder="Apa yang ingin kamu ceritakan hari ini?" id="postContent"></textarea>
            <div class="post-actions">
                <input type="text" class="user-input" placeholder="Nama kamu (opsional)" id="userName">
                <button class="post-button" onclick="createPost()" id="postButton">Bagikan Cerita</button>
            </div>
        </div>
        
        <div class="posts-container" id="postsContainer">
            <div class="loading">Memuat cerita...</div>
        </div>
    </div>

    <script>
        let posts = [];
        let retryCount = 0;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 2000;

        // Enhanced API call with retry logic
        async function apiCall(url, options = {}, retries = MAX_RETRIES) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (response.status === 429) {
                    throw new Error('Rate limit exceeded');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    console.log(`Retrying API call (${MAX_RETRIES - retries + 1}/${MAX_RETRIES})...`);
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                    return apiCall(url, options, retries - 1);
                }
                throw error;
            }
        }

        async function loadPosts() {
            try {
                const container = document.getElementById('postsContainer');
                container.innerHTML = '<div class="loading">Memuat cerita...</div>';
                
                posts = await apiCall('/api/posts');
                displayPosts();
            } catch (error) {
                console.error('Error loading posts:', error);
                showError('Gagal memuat cerita. Silakan refresh halaman.', true);
            }
        }

        function displayPosts() {
            const container = document.getElementById('postsContainer');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>Belum ada cerita</h3>
                        <p>Jadilah yang pertama berbagi cerita!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posts.map(post => `
                <div class="post" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="post-user">${escapeHtml(post.user)}</div>
                        <div class="post-date">${formatDate(post.date)}</div>
                    </div>
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    
                    <div class="post-stats">
                        <div class="stat" onclick="interactPost('${post.id}', 'like')">
                            ‚ù§Ô∏è ${post.likes || 0}
                        </div>
                        <div class="stat" onclick="showCommentSection('${post.id}')">
                            üí¨ ${post.comments || 0}
                        </div>
                        <div class="stat" onclick="interactPost('${post.id}', 'share')">
                            üîÑ ${post.shares || 0}
                        </div>
                        <div class="stat">
                            üëÅÔ∏è ${post.views || 0}
                        </div>
                    </div>
                    
                    <div class="comment-section" id="commentSection-${post.id}" style="display: none;">
                        <input type="text" class="comment-input" id="commentInput-${post.id}" 
                               placeholder="Tulis komentar..." onkeypress="if(event.key==='Enter') addComment('${post.id}')">
                        <div id="commentsList-${post.id}">
                            ${(post.commentsList || []).map(comment => `
                                <div class="comment">
                                    <div class="comment-user">${escapeHtml(comment.user)}</div>
                                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                                    <div class="comment-time">${formatDate(comment.time)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Track views for visible posts
            posts.forEach(post => interactPost(post.id, 'view'));
        }

        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            const user = document.getElementById('userName').value.trim() || 'Anonymous';
            const button = document.getElementById('postButton');
            
            if (!content) {
                showError('Silakan tulis cerita terlebih dahulu');
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Membagikan...';
            
            try {
                await apiCall('/api/posts', {
                    method: 'POST',
                    body: JSON.stringify({
                        user: user,
                        content: content
                    })
                });
                
                document.getElementById('postContent').value = '';
                showSuccess('Cerita berhasil dibagikan!');
                await loadPosts();
            } catch (error) {
                console.error('Error creating post:', error);
                showError('Gagal membagikan cerita. Silakan coba lagi.');
            } finally {
                button.disabled = false;
                button.textContent = 'Bagikan Cerita';
            }
        }

        async function interactPost(postId, action) {
            try {
                await apiCall(`/api/posts/${postId}/${action}`, {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                
                // Update local state immediately
                const post = posts.find(p => p.id === postId);
                if (post) {
                    if (action === 'like') post.likes = (post.likes || 0) + 1;
                    if (action === 'share') post.shares = (post.shares || 0) + 1;
                    if (action === 'view') post.views = (post.views || 0) + 1;
                    
                    // Update display
                    const statElement = document.querySelector(`[data-post-id="${postId}"] .stat:nth-child(${action === 'like' ? 1 : action === 'comment' ? 2 : action === 'share' ? 3 : 4})`);
                    if (statElement) {
                        const count = action === 'like' ? post.likes : action === 'share' ? post.shares : post.views;
                        statElement.innerHTML = `${getActionEmoji(action)} ${count}`;
                    }
                }
            } catch (error) {
                console.error(`Error ${action} post:`, error);
            }
        }

        function showCommentSection(postId) {
            const commentSection = document.getElementById(`commentSection-${postId}`);
            commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
        }

        async function addComment(postId) {
            const input = document.getElementById(`commentInput-${postId}`);
            const comment = input.value.trim();
            const user = document.getElementById('userName').value.trim() || 'Anonymous';
            
            if (!comment) return;
            
            try {
                await apiCall(`/api/posts/${postId}/comment`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: user,
                        comment: comment
                    })
                });
                
                // Update local state
                const post = posts.find(p => p.id === postId);
                if (post) {
                    post.comments = (post.comments || 0) + 1;
                    post.commentsList = post.commentsList || [];
                    post.commentsList.unshift({
                        user: user,
                        text: comment,
                        time: new Date().toISOString(),
                        likes: 0
                    });
                    
                    // Update display
                    const commentsList = document.getElementById(`commentsList-${postId}`);
                    commentsList.innerHTML = post.commentsList.map(c => `
                        <div class="comment">
                            <div class="comment-user">${escapeHtml(c.user)}</div>
                            <div class="comment-text">${escapeHtml(c.text)}</div>
                            <div class="comment-time">${formatDate(c.time)}</div>
                        </div>
                    `).join('');
                    
                    // Update comment count
                    const commentStat = document.querySelector(`[data-post-id="${postId}"] .stat:nth-child(2)`);
                    if (commentStat) {
                        commentStat.innerHTML = `üí¨ ${post.comments}`;
                    }
                }
                
                input.value = '';
                showSuccess('Komentar berhasil ditambahkan!');
            } catch (error) {
                console.error('Error adding comment:', error);
                showError('Gagal menambahkan komentar. Silakan coba lagi.');
            }
        }

        function getActionEmoji(action) {
            const emojis = {
                like: '‚ù§Ô∏è',
                comment: 'üí¨',
                share: 'üîÑ',
                view: 'üëÅÔ∏è'
            };
            return emojis[action] || '‚ú®';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Baru saja';
            if (diffMins < 60) return `${diffMins} menit lalu`;
            if (diffHours < 24) return `${diffHours} jam lalu`;
            if (diffDays < 7) return `${diffDays} hari lalu`;
            
            return date.toLocaleDateString('id-ID');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message, showRetry = false) {
            const container = document.getElementById('postsContainer');
            container.innerHTML = `
                <div class="error">
                    ${message}
                    ${showRetry ? '<button class="retry-button" onclick="loadPosts()">Coba Lagi</button>' : ''}
                </div>
            `;
        }

        function showSuccess(message) {
            const container = document.getElementById('postsContainer');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Auto-refresh posts every 30 seconds
        setInterval(loadPosts, 30000);

        // Initial load
        loadPosts();
    </script>
</body>
</html>